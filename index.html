<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Математический тренажер</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .shape {
            position: absolute;
            opacity: 0.3;
            animation: float 15s infinite ease-in-out;
        }
        .circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
        }
        .triangle {
            width: 0;
            height: 0;
            border-left: 50px solid transparent;
            border-right: 50px solid transparent;
            border-bottom: 100px solid rgba(255, 255, 255, 0.4);
        }
        .square {
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.4);
        }
        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }
        .container {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 10;
            position: relative;
            max-width: 600px;
            width: 90%;
            backdrop-filter: blur(5px);
        }
        h1 {
            color: #2c3e50;
            margin-top: 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        .problem {
            font-size: 28px;
            margin: 25px 0;
            padding: 20px;
            background-color: rgba(248, 249, 250, 0.7);
            border-radius: 10px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        input {
            font-size: 20px;
            padding: 10px;
            width: 120px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            transition: all 0.3s;
        }
        input:focus {
            border-color: #3498db;
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.5);
            outline: none;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            font-size: 20px;
            margin: 20px 0;
            min-height: 30px;
            font-weight: bold;
        }
        .correct {
            color: #27ae60;
        }
        .incorrect {
            color: #e74c3c;
        }
        .stats {
            margin-top: 25px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        .stat-box {
            background-color: rgba(236, 240, 241, 0.7);
            padding: 12px;
            border-radius: 8px;
            width: 28%;
            margin: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .operation-buttons {
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        .operation-btn {
            background-color: #2ecc71;
            min-width: 100px;
        }
        .operation-btn.active {
            background-color: #2ecc71;
            font-weight: bold;
            transform: scale(1.05);
        }
        /* Стили для модального окна */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        /* Стили для вкладок */
        .theory-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab-btn {
            padding: 10px 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #555;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .theory-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .theory-section h4 {
            margin-top: 0;
            color: #2c3e50;
        }
        .theory-section ul {
            padding-left: 20px;
        }
        .theory-section li {
            margin-bottom: 8px;
        }
        #theory-btn {
            background-color: #3498db;
        }
        #theory-btn:hover {
            background-color: #3498db;
        }
        #theorems-btn {
            background-color: #e67e22;
        }
        #theorems-btn:hover {
            background-color: #d35400;
        }
        .theorem-card {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .theorem-portrait {
            width: 120px;
            height: 160px;
            object-fit: cover;
        }
        .theorem-content {
            padding: 15px;
            flex: 1;
        }
        .theorem-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        .theorem-dates {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .theorem-text {
            font-size: 15px;
            line-height: 1.5;
        }
        @keyframes celebrate {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}
.correct {
  color: #27ae60;
  animation: celebrate 0.5s ease;
}
/* Эффект при наведении на карточки ученых */
.theorem-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 15px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}
/* Стили для таймера */
.timer-container {
    display: flex;
    justify-content: center;
    margin: 15px 0;
}
.timer {
    font-size: 24px;
    font-weight: bold;
    color: #2c3e50;
    background-color: rgba(255, 255, 255, 0.7);
    padding: 8px 20px;
    border-radius: 30px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
}
/* Стили для уровней сложности */
.difficulty-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 15px 0;
}
.difficulty-btn {
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
}
.difficulty-btn.active {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.difficulty-easy {
    background-color: #2ecc71;
}
.difficulty-medium {
    background-color: #f39c12;
}
.difficulty-hard {
    background-color: #e74c3c;
    color: white;
}
/* Стили для статистики */
#stats-btn {
    background-color: #9b59b6;
}
#stats-btn:hover {
    background-color: #8e44ad;
}
.stats-modal table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
}
.stats-modal th, .stats-modal td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}
.stats-modal th {
    background-color: #f2f2f2;
}
.stats-modal tr:hover {
    background-color: #f5f5f5;
}
.export-import {
    margin-top: 20px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
}
#export-stats, #import-stats, #clear-stats {
    padding: 10px 15px;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    transition: all 0.3s;
}
#export-stats {
    background-color: #2ecc71;
    color: white;
}
#import-stats {
    background-color: #3498db;
    color: white;
}
#clear-stats {
    background-color: #e74c3c;
    color: white;
}
#file-input {
    display: none;
}
/* Добавленные стили */
#achievements-btn {
    background-color: #f1c40f;
    color: #2c3e50;
}
#achievements-btn:hover {
    background-color: #f39c12;
}
#progression-btn {
    background-color: #1abc9c;
    color: white;
}
#progression-btn:hover {
    background-color: #16a085;
}
.achievement-card {
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    background-color: #ecf0f1;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
}
.achievement-card.unlocked {
    background-color: #d5f5e3;
    border-left: 5px solid #27ae60;
}
.achievement-icon {
    font-size: 24px;
    margin-right: 15px;
    width: 40px;
    text-align: center;
}
.achievement-info {
    flex: 1;
}
.achievement-name {
    font-weight: bold;
    margin-bottom: 5px;
}
.achievement-desc {
    font-size: 14px;
    color: #7f8c8d;
}
.progression-stage {
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    background-color: #f8f9fa;
    border: 1px solid #ddd;
}
.progression-stage.completed {
    background-color: #e8f5e9;
    border-color: #4caf50;
}
.stage-title {
    font-weight: bold;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
}
.stage-icon {
    margin-right: 10px;
    font-size: 20px;
}
.stage-achievements {
    margin-top: 10px;
    padding-left: 20px;
}
.stage-achievement {
    margin: 5px 0;
    padding: 8px;
    background-color: #eee;
    border-radius: 4px;
    font-size: 14px;
}
.stage-achievement.unlocked {
    background-color: #c8e6c9;
    color: #2e7d32;
}
/* Стили для окна согласия */
#consent-modal {
    display: flex;
    justify-content: center;
    align-items: center;
}
#consent-modal .modal-content {
    text-align: center;
    max-width: 500px;
}
.consent-buttons {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 20px;
}
.consent-btn {
    padding: 12px 25px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}
#agree-btn {
    background-color: #27ae60;
    color: white;
}
#disagree-btn {
    background-color: #e74c3c;
    color: white;
}
.consent-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 8px rgba(0,0,0,0.15);
}
#agree-btn:hover {
    background-color: #219653;
}
#disagree-btn:hover {
    background-color: #c0392b;
}
.no-save-message {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
    color: #856404;
    text-align: center;
    font-weight: bold;
}
    </style>
</head>
<body>
    <!-- Плавающие геометрические фигуры -->
    <div class="shape circle" style="top:10%; left:5%; animation-delay:0s;"></div>
    <div class="shape triangle" style="top:70%; left:10%; animation-delay:2s;"></div>
    <div class="shape square" style="top:20%; left:80%; animation-delay:4s;"></div>
    <div class="shape circle" style="top:80%; left:85%; animation-delay:6s;"></div>
    <div class="shape triangle" style="top:30%; left:15%; animation-delay:8s;"></div>
    <div class="shape square" style="top:60%; left:75%; animation-delay:10s;"></div>
    
    <!-- Модальное окно согласия -->
    <div id="consent-modal" class="modal" style="display: flex;">
        <div class="modal-content">
            <h2>Добро пожаловать в Математический тренажер!</h2>
            <p>Мы хотим уведомить вас, что все достижения, статистика решений примеров будут сохраняться в вашем браузере.</p>
            <p>Это позволит вам отслеживать свой прогресс и возвращаться к тренировкам без потери данных.</p>
            <div class="consent-buttons">
                <button id="agree-btn" class="consent-btn">Да, я согласен</button>
                <button id="disagree-btn" class="consent-btn">Нет, спасибо</button>
            </div>
        </div>
    </div>
    
    <div class="container" id="main-container" style="display: none;">
        <h1>Математический тренажер</h1>
        <div id="no-save-warning" class="no-save-message" style="display: none;">
            Результаты не будут сохраняться
        </div>
        <!-- Уровни сложности -->
        <div class="difficulty-buttons">
            <button class="difficulty-btn difficulty-easy active" data-difficulty="easy">Легкий</button>
            <button class="difficulty-btn difficulty-medium" data-difficulty="medium">Средний</button>
            <button class="difficulty-btn difficulty-hard" data-difficulty="hard">Сложный</button>
        </div>
        <!-- Таймер -->
        <div class="timer-container">
            <div class="timer">Время: <span id="time">30</span> сек</div>
        </div>
        <div class="operation-buttons">
            <button class="operation-btn active" data-operation="+">Сложение</button>
            <button class="operation-btn" data-operation="-">Вычитание</button>
            <button class="operation-btn" data-operation="*">Умножение</button>
            <button class="operation-btn" data-operation="/">Деление</button>
            <button id="theory-btn">Теория</button>
            <button id="theorems-btn">Теоремы</button>
            <button id="stats-btn">Статистика</button>
            <button id="achievements-btn">Достижения</button>
            <button id="progression-btn">Прохождение</button>
        </div>
        <div class="problem" id="problem">2 + 3 = ?</div>
        <div>
            <input type="number" id="answer" placeholder="Ответ">
            <div>
                <button id="check">Проверить</button>
                <button id="next">Следующий</button>
            </div>
        </div>
        <div class="result" id="result"></div>
        <div class="stats">
            <div class="stat-box">
                Правильно: <span id="correct">0</span>
            </div>
            <div class="stat-box">
                Неправильно: <span id="incorrect">0</span>
            </div>
            <div class="stat-box">
                Всего: <span id="total">0</span>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно теории -->
    <div id="theory-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Теория математики</h2>
            <div class="theory-tabs">
                <button class="tab-btn active" data-tab="school">Школа (1-9 класс)</button>
                <button class="tab-btn" data-tab="college">Колледж</button>
                <button class="tab-btn" data-tab="university">Университет</button>
            </div>
            <div class="tab-content active" id="school-tab">
                <h3>Основы математики (1-9 класс)</h3>
                <div class="theory-section">
                    <h4>1-4 класс</h4>
                    <ul>
                        <li>Сложение и вычитание</li>
                        <li>Умножение и деление</li>
                        <li>Дроби</li>
                        <li>Геометрические фигуры</li>
                    </ul>
                </div>
                <div class="theory-section">
                    <h4>5-9 класс</h4>
                    <ul>
                        <li>Обыкновенные и десятичные дроби</li>
                        <li>Проценты</li>
                        <li>Алгебраические выражения</li>
                        <li>Уравнения</li>
                        <li>Геометрия: площади, объемы</li>
                    </ul>
                </div>
            </div>
            <div class="tab-content" id="college-tab">
                <h3>Математика для колледжа</h3>
                <div class="theory-section">
                    <ul>
                        <li>Основы алгебры</li>
                        <li>Тригонометрия</li>
                        <li>Логарифмы</li>
                        <li>Основы математического анализа</li>
                        <li>Прикладная математика</li>
                    </ul>
                </div>
            </div>
            <div class="tab-content" id="university-tab">
                <h3>Высшая математика</h3>
                <div class="theory-section">
                    <ul>
                        <li>Математический анализ</li>
                        <li>Линейная алгебра</li>
                        <li>Дифференциальные уравнения</li>
                        <li>Теория вероятностей</li>
                        <li>Дискретная математика</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно теорем -->
    <div id="theorems-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('theorems-modal').style.display='none'">&times;</span>
            <h2>Великие теоремы и ученые</h2>
            <div class="theorem-card">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/99/Pythagoras.jpg/220px-Pythagoras.jpg" alt="Пифагор" class="theorem-portrait">
                <div class="theorem-content">
                    <div class="theorem-name">Пифагор Самосский</div>
                    <div class="theorem-dates">ок. 570 - ок. 495 до н.э.</div>
                    <div class="theorem-text">
                        <strong>Теорема Пифагора:</strong> В прямоугольном треугольнике квадрат гипотенузы равен сумме квадратов катетов.
                        c² = a² + b². Эта теорема лежит в основе евклидовой геометрии и имеет множество приложений.
                    </div>
                </div>
            </div>
            <div class="theorem-card">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/73/Euclid.jpg/220px-Euclid.jpg" alt="Евклид" class="theorem-portrait">
                <div class="theorem-content">
                    <div class="theorem-name">Евклид</div>
                    <div class="theorem-dates">ок. 325 - ок. 265 до н.э.</div>
                    <div class="theorem-text">
                        <strong>Аксиоматика Евклида:</strong> Создал стройную систему геометрии, основанную на аксиомах. Его труд "Начала" стал основой для преподавания математики на протяжении более 2000 лет.
                    </div>
                </div>
            </div>
            <div class="theorem-card">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Nikola_Tesla.jpg/220px-Nikola_Tesla.jpg" alt="Ферма" class="theorem-portrait">
                <div class="theorem-content">
                    <div class="theorem-name">Пьер де Ферма</div>
                    <div class="theorem-dates">1601-1665</div>
                    <div class="theorem-text">
                        <strong>Великая теорема Ферма:</strong> Уравнение xⁿ + yⁿ = zⁿ не имеет решений в натуральных числах при n > 2. Доказана Эндрю Уайлсом только в 1994 году.
                    </div>
                </div>
            </div>
            <div class="theorem-card">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/98/Carl_Friedrich_Gauss.jpg/220px-Carl_Friedrich_Gauss.jpg" alt="Гаусс" class="theorem-portrait">
                <div class="theorem-content">
                    <div class="theorem-name">Карл Фридрих Гаусс</div>
                    <div class="theorem-dates">1777-1855</div>
                    <div class="theorem-text">
                        <strong>Основная теорема алгебры:</strong> Любое алгебраическое уравнение степени n с комплексными коэффициентами имеет ровно n комплексных корней (с учетом кратности). Гаусс дал первое строгое доказательство этой теоремы.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно статистики -->
    <div id="stats-modal" class="modal stats-modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('stats-modal').style.display='none'">&times;</span>
            <h2>Статистика прохождения</h2>
            <table id="stats-table">
                <thead>
                    <tr>
                        <th>Дата</th>
                        <th>Операция</th>
                        <th>Уровень</th>
                        <th>Результат</th>
                        <th>Время</th>
                    </tr>
                </thead>
                <tbody id="stats-body">
                    <!-- Сюда будет вставляться статистика -->
                </tbody>
            </table>
            <div class="export-import">
                <button id="export-stats">Экспорт в JSON</button>
                <button id="import-stats">Импорт из JSON</button>
                <input type="file" id="file-input" accept=".json" style="display: none;">
                <button id="clear-stats">Очистить статистику</button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно достижений -->
    <div id="achievements-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('achievements-modal').style.display='none'">&times;</span>
            <h2>Достижения</h2>
            <div id="achievements-list">
                <!-- Сюда будут добавляться достижения -->
            </div>
        </div>
    </div>

    <!-- Модальное окно прохождения -->
    <div id="progression-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('progression-modal').style.display='none'">&times;</span>
            <h2>Прохождение</h2>
            <div id="progression-stages">
                <!-- Сюда будут добавляться этапы прохождения -->
            </div>
        </div>
    </div>
    
    <script>
        // Флаг для отслеживания согласия пользователя
        let userConsent = localStorage.getItem('mathTrainerConsent') === 'true';
        let saveData = userConsent; // Флаг для определения, нужно ли сохранять данные
        
        // Показать или скрыть главное окно в зависимости от согласия
        if (userConsent) {
            document.getElementById('consent-modal').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
        }
        
        // Обработчики для кнопок согласия
        document.getElementById('agree-btn').addEventListener('click', function() {
            localStorage.setItem('mathTrainerConsent', 'true');
            userConsent = true;
            saveData = true;
            document.getElementById('consent-modal').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            initApp();
        });
        
        document.getElementById('disagree-btn').addEventListener('click', function() {
            localStorage.setItem('mathTrainerConsent', 'false');
            userConsent = false;
            saveData = false;
            document.getElementById('consent-modal').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            document.getElementById('no-save-warning').style.display = 'block';
            initApp();
        });
        
        // Остальные переменные и функции
        let currentOperation = '+';
        let currentDifficulty = 'easy';
        let num1, num2, correctAnswer;
        let correctCount = 0;
        let incorrectCount = 0;
        let totalCount = 0;
        let timeLeft = 30;
        let initialTime = 30;
        let timer;
        let stats = [];
        let achievements = {};
        
        // Инициализация данных из localStorage, если пользователь дал согласие
        if (userConsent) {
            stats = JSON.parse(localStorage.getItem('mathTrainerStats')) || [];
            achievements = JSON.parse(localStorage.getItem('mathTrainerAchievements')) || {};
        }
        
        // Добавленные переменные и функции
        const achievementList = [
            {id: 'first_correct', name: 'Первый успех', desc: 'Правильно решите первую задачу', icon: '🥇'},
            {id: 'ten_correct', name: 'Десяточка', desc: 'Правильно решите 10 задач', icon: '⭐'},
            {id: 'fast_solver', name: 'Быстрый решатель', desc: 'Решите задачу менее чем за 5 секунд', icon: '⚡'},
            {id: 'perfect_score', name: 'Без ошибок', desc: 'Решите 5 задач подряд без ошибок', icon: '🎯'},
            {id: 'master_addition', name: 'Мастер сложения', desc: 'Правильно решите 20 задач на сложение', icon: '➕'},
            {id: 'division_expert', name: 'Эксперт по делению', desc: 'Правильно решите 15 задач на деление', icon: '➗'}
        ];

        const progressionStages = [
            {
                id: 'beginner',
                title: 'Новичок',
                description: 'Начните свой путь в математике',
                achievements: ['first_correct'],
                icon: '🌱'
            },
            {
                id: 'apprentice',
                title: 'Ученик',
                description: 'Решите 10 задач правильно',
                achievements: ['ten_correct', 'fast_solver'],
                icon: '📚'
            },
            {
                id: 'adept',
                title: 'Знаток',
                description: 'Освойте все основные операции',
                achievements: ['perfect_score', 'master_addition', 'division_expert'],
                icon: '🎓'
            }
        ];
        
        // Элементы DOM
        const problemElement = document.getElementById('problem');
        const answerElement = document.getElementById('answer');
        const resultElement = document.getElementById('result');
        const checkButton = document.getElementById('check');
        const nextButton = document.getElementById('next');
        const correctElement = document.getElementById('correct');
        const incorrectElement = document.getElementById('incorrect');
        const totalElement = document.getElementById('total');
        const timeElement = document.getElementById('time');
        const operationButtons = document.querySelectorAll('.operation-btn');
        const difficultyButtons = document.querySelectorAll('.difficulty-btn');
        const theoryBtn = document.getElementById('theory-btn');
        const theoremsBtn = document.getElementById('theorems-btn');
        const statsBtn = document.getElementById('stats-btn');
        const exportStatsBtn = document.getElementById('export-stats');
        const importStatsBtn = document.getElementById('import-stats');
        const clearStatsBtn = document.getElementById('clear-stats');
        const fileInput = document.getElementById('file-input');
        const statsBody = document.getElementById('stats-body');
        
        // Добавленные элементы DOM
        const achievementsBtn = document.getElementById('achievements-btn');
        const progressionBtn = document.getElementById('progression-btn');
        
        // Функция инициализации приложения
        function initApp() {
            // Генерация новой задачи
            function generateProblem() {
                answerElement.value = '';
                resultElement.textContent = '';
                resultElement.className = 'result';
                clearInterval(timer);
                // Устанавливаем время в зависимости от сложности
                switch(currentDifficulty) {
                    case 'easy': 
                        timeLeft = 45;
                        initialTime = 45;
                        break;
                    case 'medium': 
                        timeLeft = 30;
                        initialTime = 30;
                        break;
                    case 'hard': 
                        timeLeft = 15;
                        initialTime = 15;
                        break;
                }
                timeElement.textContent = timeLeft;
                startTimer();
                // Генерация чисел в зависимости от сложности
                let maxNum, minNum;
                switch(currentDifficulty) {
                    case 'easy':
                        maxNum = 20;
                        minNum = 1;
                        break;
                    case 'medium':
                        maxNum = 50;
                        minNum = 10;
                        break;
                    case 'hard':
                        maxNum = 100;
                        minNum = 20;
                        break;
                }
                switch(currentOperation) {
                    case '+':
                        num1 = Math.floor(Math.random() * maxNum) + minNum;
                        num2 = Math.floor(Math.random() * maxNum) + minNum;
                        correctAnswer = num1 + num2;
                        break;
                    case '-':
                        num1 = Math.floor(Math.random() * maxNum) + minNum;
                        num2 = Math.floor(Math.random() * num1) + 1;
                        correctAnswer = num1 - num2;
                        break;
                    case '*':
                        num1 = Math.floor(Math.random() * (maxNum/5)) + minNum;
                        num2 = Math.floor(Math.random() * (maxNum/5)) + minNum;
                        correctAnswer = num1 * num2;
                        break;
                    case '/':
                        num2 = Math.floor(Math.random() * 10) + 1;
                        correctAnswer = Math.floor(Math.random() * 10) + 1;
                        num1 = num2 * correctAnswer;
                        break;
                }
                problemElement.textContent = `${num1} ${currentOperation} ${num2} = ?`;
                answerElement.focus();
            }
            
            // Таймер
            function startTimer() {
                timer = setInterval(() => {
                    timeLeft--;
                    timeElement.textContent = timeLeft;
                    if(timeLeft <= 0) {
                        clearInterval(timer);
                        resultElement.textContent = '⏱ Время вышло!';
                        resultElement.className = 'result incorrect';
                        saveStat(currentOperation, currentDifficulty, false, initialTime);
                        incorrectCount++;
                        totalCount++;
                        updateStats();
                    }
                }, 1000);
            }
            
            // Проверка ответа
            function checkAnswer() {
                clearInterval(timer);
                const timeSpent = initialTime - timeLeft;
                const userAnswer = parseInt(answerElement.value);
                if (isNaN(userAnswer)) {
                    resultElement.textContent = 'Введите число!';
                    resultElement.className = 'result incorrect';
                    return;
                }
                
                const wasCorrect = (userAnswer === correctAnswer);
                
                if (wasCorrect) {
                    resultElement.textContent = '✅ Правильно!';
                    resultElement.className = 'result correct';
                    correctCount++;
                    saveStat(currentOperation, currentDifficulty, true, timeSpent);
                    
                    // Проверка специфических достижений
                    if (timeSpent < 5 && !achievements['fast_solver']) {
                        unlockAchievement('fast_solver');
                    }
                } else {
                    resultElement.textContent = `❌ Неправильно! Правильный ответ: ${correctAnswer}`;
                    resultElement.className = 'result incorrect';
                    incorrectCount++;
                    saveStat(currentOperation, currentDifficulty, false, timeSpent);
                }
                
                totalCount++;
                updateStats();
                checkAchievements(); // Проверяем достижения после каждого ответа
            }
            
            // Сохранение статистики
            function saveStat(operation, difficulty, isCorrect, timeSpent) {
                if (!saveData) return; // Не сохраняем, если пользователь не дал согласие
                
                const operationNames = {
                    '+': 'Сложение',
                    '-': 'Вычитание',
                    '*': 'Умножение',
                    '/': 'Деление'
                };
                const difficultyNames = {
                    'easy': 'Легкий',
                    'medium': 'Средний',
                    'hard': 'Сложный'
                };
                const statEntry = {
                    date: new Date().toLocaleString(),
                    operation: operationNames[operation],
                    difficulty: difficultyNames[difficulty],
                    result: isCorrect ? 'Правильно' : 'Неправильно',
                    time: timeSpent + ' сек'
                };
                stats.push(statEntry);
                if (userConsent) {
                    localStorage.setItem('mathTrainerStats', JSON.stringify(stats));
                }
            }
            
            // Показать статистику
            function showStats() {
                statsBody.innerHTML = '';
                stats.forEach(stat => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${stat.date}</td>
                        <td>${stat.operation}</td>
                        <td>${stat.difficulty}</td>
                        <td>${stat.result}</td>
                        <td>${stat.time}</td>
                    `;
                    statsBody.appendChild(row);
                });
                document.getElementById('stats-modal').style.display = 'block';
            }
            
            // Экспорт статистики
            function exportStats() {
                if (!saveData) {
                    alert('Экспорт недоступен, так как вы не дали согласие на сохранение данных.');
                    return;
                }
                const dataStr = JSON.stringify(stats, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'math-trainer-stats.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            }
            
            // Импорт статистики
            function importStats() {
                if (!saveData) {
                    alert('Импорт недоступен, так как вы не дали согласие на сохранение данных.');
                    return;
                }
                fileInput.click();
            }
            
            // Очистка статистики
            function clearStats() {
                if (!saveData) {
                    alert('Очистка недоступна, так как вы не дали согласие на сохранение данных.');
                    return;
                }
                if (confirm('Вы уверены, что хотите очистить всю статистику?')) {
                    stats = [];
                    if (userConsent) {
                        localStorage.removeItem('mathTrainerStats');
                    }
                    showStats();
                }
            }
            
            // Обновление статистики
            function updateStats() {
                correctElement.textContent = correctCount;
                incorrectElement.textContent = incorrectCount;
                totalElement.textContent = totalCount;
            }
            
            // Функция для проверки и разблокировки достижений
            function checkAchievements() {
                if (!saveData) return; // Не проверяем достижения, если не сохраняем данные
                
                // Проверка достижений
                if (!achievements['first_correct'] && correctCount >= 1) {
                    unlockAchievement('first_correct');
                }
                if (!achievements['ten_correct'] && correctCount >= 10) {
                    unlockAchievement('ten_correct');
                }
                if (!achievements['master_addition'] && getOperationStats('+') >= 20) {
                    unlockAchievement('master_addition');
                }
                if (!achievements['division_expert'] && getOperationStats('/') >= 15) {
                    unlockAchievement('division_expert');
                }
                // Проверка на серию правильных ответов
                if (!achievements['perfect_score']) {
                    // Для простоты примера, проверим только текущую сессию
                    // В реальном приложении лучше хранить счетчик последовательных правильных ответов
                }
            }

            // Вспомогательная функция для подсчета решенных задач по операции
            function getOperationStats(operation) {
                return stats.filter(s => 
                    s.operation === getOperationName(operation) && 
                    s.result === 'Правильно'
                ).length;
            }

            function getOperationName(op) {
                const names = {
                    '+': 'Сложение',
                    '-': 'Вычитание',
                    '*': 'Умножение',
                    '/': 'Деление'
                };
                return names[op] || op;
            }

            // Функция для разблокировки достижения
            function unlockAchievement(id) {
                if (!saveData) return; // Не разблокируем достижения, если не сохраняем данные
                
                if (!achievements[id]) {
                    achievements[id] = new Date().toLocaleString();
                    if (userConsent) {
                        localStorage.setItem('mathTrainerAchievements', JSON.stringify(achievements));
                    }
                    // Здесь можно добавить визуальное уведомление о новом достижении
                    console.log(`Достижение разблокировано: ${id}`);
                }
            }

            // Функция для отображения достижений
            function showAchievements() {
                if (!saveData) {
                    alert('Достижения недоступны, так как вы не дали согласие на сохранение данных.');
                    return;
                }
                const list = document.getElementById('achievements-list');
                list.innerHTML = '';
                
                achievementList.forEach(ach => {
                    const isUnlocked = achievements[ach.id];
                    const card = document.createElement('div');
                    card.className = `achievement-card ${isUnlocked ? 'unlocked' : ''}`;
                    card.innerHTML = `
                        <div class="achievement-icon">${ach.icon}</div>
                        <div class="achievement-info">
                            <div class="achievement-name">${ach.name}</div>
                            <div class="achievement-desc">${ach.desc}</div>
                            ${isUnlocked ? `<div class="achievement-date">Разблокировано: ${achievements[ach.id]}</div>` : ''}
                        </div>
                    `;
                    list.appendChild(card);
                });
                
                document.getElementById('achievements-modal').style.display = 'block';
            }

            // Функция для отображения прохождения
            function showProgression() {
                if (!saveData) {
                    alert('Прохождение недоступно, так как вы не дали согласие на сохранение данных.');
                    return;
                }
                const stagesContainer = document.getElementById('progression-stages');
                stagesContainer.innerHTML = '';
                
                progressionStages.forEach(stage => {
                    const isCompleted = stage.achievements.every(id => achievements[id]);
                    const stageElement = document.createElement('div');
                    stageElement.className = `progression-stage ${isCompleted ? 'completed' : ''}`;
                    
                    let achievementsHtml = '';
                    stage.achievements.forEach(achId => {
                        const ach = achievementList.find(a => a.id === achId);
                        const isUnlocked = achievements[achId];
                        achievementsHtml += `
                            <div class="stage-achievement ${isUnlocked ? 'unlocked' : ''}">
                                ${ach.icon} ${ach.name}
                            </div>
                        `;
                    });
                    
                    stageElement.innerHTML = `
                        <div class="stage-title">
                            <span class="stage-icon">${stage.icon}</span>
                            <span>${stage.title}</span>
                            ${isCompleted ? '<span style="margin-left: auto; color: #4caf50;">✓ Завершено</span>' : ''}
                        </div>
                        <div>${stage.description}</div>
                        <div class="stage-achievements">
                            <strong>Достижения этапа:</strong>
                            ${achievementsHtml}
                        </div>
                    `;
                    
                    stagesContainer.appendChild(stageElement);
                });
                
                document.getElementById('progression-modal').style.display = 'block';
            }
            
            // Обработчики событий
            checkButton.addEventListener('click', checkAnswer);
            nextButton.addEventListener('click', generateProblem);
            answerElement.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkAnswer();
                }
            });
            operationButtons.forEach(button => {
                button.addEventListener('click', function() {
                    operationButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentOperation = this.dataset.operation;
                    generateProblem();
                });
            });
            difficultyButtons.forEach(button => {
                button.addEventListener('click', function() {
                    difficultyButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentDifficulty = this.dataset.difficulty;
                    generateProblem();
                });
            });
            theoryBtn.addEventListener('click', function() {
                document.getElementById('theory-modal').style.display = 'block';
            });
            theoremsBtn.addEventListener('click', function() {
                document.getElementById('theorems-modal').style.display = 'block';
            });
            statsBtn.addEventListener('click', showStats);
            exportStatsBtn.addEventListener('click', exportStats);
            importStatsBtn.addEventListener('click', importStats);
            clearStatsBtn.addEventListener('click', clearStats);
            fileInput.addEventListener('change', function(e) {
                if (!saveData) return;
                
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedStats = JSON.parse(e.target.result);
                        stats = importedStats;
                        if (userConsent) {
                            localStorage.setItem('mathTrainerStats', JSON.stringify(stats));
                        }
                        showStats();
                        alert('Статистика успешно импортирована!');
                    } catch (error) {
                        alert('Ошибка при импорте файла: неверный формат');
                    }
                };
                reader.readAsText(file);
            });
            
            // Добавленные обработчики событий
            achievementsBtn.addEventListener('click', showAchievements);
            progressionBtn.addEventListener('click', showProgression);
            
            // Закрытие модальных окон при клике вне их
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });
            
            // Инициализация
            generateProblem();
            updateStats();
        }
    </script>
</body>
</html>